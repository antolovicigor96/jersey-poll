<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jersey Voting</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #d2691e;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 15px;
        }

        .voting-instructions {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .points-display {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .points-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
        }

        .name-entry {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
        }

        .name-entry input {
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-right: 10px;
            width: 250px;
        }

        .name-entry button {
            padding: 12px 25px;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .name-entry button:hover {
            background: #e55a2b;
        }

        .voting-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .jersey-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .jersey-card.selected {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
            border: 3px solid #ff6b35;
        }

        .jersey-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .jersey-info {
            padding: 20px;
            text-align: center;
        }

        .jersey-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .points-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .point-btn {
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .point-btn:hover {
            background: #e0e0e0;
        }

        .point-btn.selected {
            background: #ff6b35;
            color: white;
            border-color: #ff6b35;
        }

        .submit-btn {
            display: block;
            margin: 30px auto;
            padding: 15px 40px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        .current-voter {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 10px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .points-display {
                flex-direction: column;
                align-items: center;
            }
            
            .voting-grid {
                grid-template-columns: 1fr;
            }
            
            .name-entry input {
                width: 100%;
                margin-bottom: 15px;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó≥Ô∏è Vote for Your Favorite Jersey</h1>
            <p class="subtitle">Use the 3-2-1 point system to rank your top choices</p>
        </div>

        <div class="voting-instructions">
            <h3>üèÜ How to Vote</h3>
            <p>Allocate your points to your favorite jersey designs:</p>
            <div class="points-display">
                <div class="points-badge">ü•á First Choice: 3 Points</div>
                <div class="points-badge">ü•à Second Choice: 2 Points</div>
                <div class="points-badge">ü•â Third Choice: 1 Point</div>
            </div>
            <p><strong>You must allocate all 6 points to submit your vote!</strong></p>
        </div>

        <div id="nameEntry" class="name-entry">
            <h3>üë§ Enter Your Name</h3>
            <p style="margin-bottom: 20px;">Please enter your name to start voting:</p>
            <input type="text" id="voterName" placeholder="Your full name">
            <button onclick="startVoting()">Start Voting üó≥Ô∏è</button>
            <p style="margin-top: 15px; font-size: 14px; color: #666;">
                Names are used to prevent duplicate voting and show participation.
            </p>
        </div>

        <div id="currentVoter" class="current-voter hidden">
            üó≥Ô∏è Voting as: <span id="currentVoterName"></span>
        </div>

        <div id="loadingMessage" class="loading hidden">
            <h3>üèÄ Loading Jersey Designs...</h3>
            <p>Please wait while we load the jersey options from the database.</p>
            <div style="margin: 20px 0;">‚è≥ Loading...</div>
        </div>

        <div id="errorMessage" class="message error hidden">
            <h3>‚ö†Ô∏è Loading Error</h3>
            <p id="errorText">Unable to load jersey data.</p>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #ff6b35; color: white; border: none; border-radius: 5px; cursor: pointer;">
                üîÑ Reload Page
            </button>
        </div>

        <div id="noJerseysMessage" class="loading hidden">
            <h3>üèÄ No Jersey Designs Available</h3>
            <p>The poll administrator hasn't uploaded any jersey designs yet.</p>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">
                üîÑ Refresh Page
            </button>
        </div>

        <div id="votingGrid" class="voting-grid hidden">
            <!-- Jersey cards will be inserted here -->
        </div>

        <button id="submitBtn" class="submit-btn hidden" onclick="submitVote()">
            Submit My Vote (0/6 points allocated)
        </button>

        <div id="successMessage" class="message success hidden">
            üéâ Your vote has been successfully submitted! Thank you for participating.
        </div>
    </div>

    <script>
        // Configuration
        const JSONBIN_CONFIG = {
            apiKey: '$2a$10$8WfZv9.7uTTJSQy3IUYRLObTfyA65QlExXIHfKgM0sDTvFqBFEQx6',
            binId: '68ab35b9d0ea881f4062e709',
            baseUrl: 'https://api.jsonbin.io/v3'
        };

        // State
        let jerseys = [];
        let votes = [];
        let currentVote = {};
        let currentVoter = null;
        let hasVoted = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await loadData();
            checkVotingStatus();
            updateDisplay();
        });

        async function loadData() {
            showElement('loadingMessage');
            
            try {
                console.log('Loading data from JSONBin...');
                const response = await fetch(`${JSONBIN_CONFIG.baseUrl}/b/${JSONBIN_CONFIG.binId}`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': JSONBIN_CONFIG.apiKey
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Data loaded successfully:', data);

                if (data && data.record) {
                    jerseys = data.record.jerseys || [];
                    votes = data.record.votes || [];
                    console.log(`Loaded ${jerseys.length} jerseys and ${votes.length} votes`);
                } else {
                    throw new Error('Invalid data structure received');
                }

            } catch (error) {
                console.error('Failed to load data:', error);
                showError('Failed to load jersey data: ' + error.message);
                return;
            }

            hideElement('loadingMessage');
        }

        function checkVotingStatus() {
            const storedVote = localStorage.getItem('jersey-poll-vote');
            const storedVoter = localStorage.getItem('jersey-poll-voter-name');
            
            if (storedVote && storedVoter) {
                hasVoted = true;
                currentVoter = storedVoter;
            }
        }

        function updateDisplay() {
            if (hasVoted) {
                showVoteComplete();
                return;
            }

            if (jerseys.length === 0) {
                showElement('noJerseysMessage');
                return;
            }

            if (!currentVoter) {
                showElement('nameEntry');
                return;
            }

            showVotingInterface();
        }

        function startVoting() {
            const nameInput = document.getElementById('voterName');
            const voterName = nameInput.value.trim();
            
            if (!voterName) {
                alert('Please enter your name to continue!');
                nameInput.focus();
                return;
            }

            // Check if this name already voted
            if (votes.some(vote => vote.voterName.toLowerCase() === voterName.toLowerCase())) {
                alert(`${voterName} has already voted! Please use a different name if you haven't voted yet.`);
                nameInput.focus();
                return;
            }

            currentVoter = voterName;
            document.getElementById('currentVoterName').textContent = voterName;
            
            hideElement('nameEntry');
            showVotingInterface();
        }

        function showVotingInterface() {
            showElement('currentVoter');
            showElement('votingGrid');
            showElement('submitBtn');
            
            renderJerseys();
            updateSubmitButton();
        }

        function renderJerseys() {
            const grid = document.getElementById('votingGrid');
            
            grid.innerHTML = jerseys.map(jersey => `
                <div class="jersey-card" id="card-${jersey.id}">
                    <img src="${jersey.image}" alt="${jersey.name}" onerror="this.style.display='none';">
                    <div class="jersey-info">
                        <div class="jersey-name">${jersey.name}</div>
                        <div class="points-selector">
                            <button class="point-btn" onclick="selectPoints('${jersey.id}', 3)">3</button>
                            <button class="point-btn" onclick="selectPoints('${jersey.id}', 2)">2</button>
                            <button class="point-btn" onclick="selectPoints('${jersey.id}', 1)">1</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selectPoints(jerseyId, points) {
            // Remove any existing selection for this point value or jersey
            Object.keys(currentVote).forEach(id => {
                if (currentVote[id] === points || id === jerseyId) {
                    delete currentVote[id];
                }
            });

            // Add new selection
            currentVote[jerseyId] = points;

            updateVisualFeedback();
            updateSubmitButton();
        }

        function updateVisualFeedback() {
            // Reset all cards
            document.querySelectorAll('.jersey-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelectorAll('.point-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
            });

            // Highlight selected items
            Object.keys(currentVote).forEach(jerseyId => {
                const card = document.getElementById(`card-${jerseyId}`);
                const points = currentVote[jerseyId];
                
                card.classList.add('selected');
                const buttons = card.querySelectorAll('.point-btn');
                buttons[3 - points].classList.add('selected'); // 3->0, 2->1, 1->2
            });
        }

        function updateSubmitButton() {
            const button = document.getElementById('submitBtn');
            const totalPoints = Object.values(currentVote).reduce((sum, points) => sum + points, 0);
            const selectedCount = Object.keys(currentVote).length;

            button.textContent = `Submit My Vote (${totalPoints}/6 points allocated)`;
            button.disabled = totalPoints !== 6 || selectedCount !== 3;
        }

        async function submitVote() {
            if (Object.values(currentVote).reduce((sum, points) => sum + points, 0) !== 6) {
                alert('Please allocate exactly 6 points (3+2+1) before submitting!');
                return;
            }

            const voteData = {
                id: Date.now(),
                voterName: currentVoter,
                vote: {...currentVote},
                timestamp: new Date().toISOString()
            };

            try {
                // Add vote to array
                votes.push(voteData);

                // Save to JSONBin
                const data = {
                    jerseys: jerseys,
                    votes: votes,
                    lastUpdated: new Date().toISOString(),
                    pollName: 'Basketball Jersey Poll'
                };

                const response = await fetch(`${JSONBIN_CONFIG.baseUrl}/b/${JSONBIN_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_CONFIG.apiKey
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // Save locally
                localStorage.setItem('jersey-poll-vote', JSON.stringify(voteData));
                localStorage.setItem('jersey-poll-voter-name', currentVoter);
                
                hasVoted = true;
                currentVote = {};

                showVoteComplete();

            } catch (error) {
                console.error('Failed to submit vote:', error);
                alert('Failed to submit vote: ' + error.message);
            }
        }

        function showVoteComplete() {
            hideElement('nameEntry');
            hideElement('currentVoter');
            hideElement('votingGrid');
            hideElement('submitBtn');
            showElement('successMessage');
            
            if (currentVoter) {
                document.querySelector('#successMessage').innerHTML = 
                    `üéâ Thank you ${currentVoter}! Your vote has been successfully submitted.`;
            }
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            showElement('errorMessage');
        }

        function showElement(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideElement(id) {
            document.getElementById(id).classList.add('hidden');
        }
    </script>
</body>
</html>