<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giganti - Glasanje za Dresove</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav-buttons {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 24px;
            margin: 0 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .nav-btn.active {
            background: #764ba2;
            color: white;
        }

        .nav-btn.hidden {
            display: none;
        }

        .view {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .view.active {
            display: block;
        }

        .voter-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .voter-form input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .voter-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .jersey-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .jersey-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .jersey-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .jersey-card.has-vote {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .jersey-card img {
            width: 100%;
            max-width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .jersey-card h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .vote-options {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .point-btn {
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px;
            font-size: 16px;
        }

        .point-btn:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        .point-btn.selected {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            transform: scale(1.05);
        }

        .point-btn.selected:hover {
            background: linear-gradient(45deg, #764ba2, #667eea);
        }

        .vote-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 0 auto;
        }

        .vote-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .vote-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .instructions {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .results-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .jersey-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }

            .nav-btn {
                padding: 10px 20px;
                font-size: 14px;
                margin: 5px;
            }

            .point-btn {
                padding: 8px 12px;
                min-width: 40px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÄ GIGANTI</h1>
            <p>Glasanje za Dresove - Sezona 2025</p>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showView('voting')">Glasanje</button>
            <button id="resultsBtn" class="nav-btn hidden" onclick="showView('results')">Rezultati</button>
        </div>

        <!-- Voting View -->
        <div id="voting-view" class="view active">
            <div class="instructions">
                <h3>üìù Instrukcije za glasanje:</h3>
                <ul>
                    <li>Unesite svoje ime (mora biti jedinstveno)</li>
                    <li>Kliknite dugmad ispod dresova da dodelite poene</li>
                    <li>Morate dodeliti taƒçno jednom dresu 3 boda, jednom 2 boda, i jednom 1 bod</li>
                    <li>Kliknite "Glasaj" da potvrdite</li>
                </ul>
            </div>

            <div class="voter-form">
                <input type="text" id="voterName" placeholder="Unesite va≈°e ime..." maxlength="50">
                <div id="nameError" class="error" style="display: none;"></div>
            </div>

            <div id="jerseyGrid" class="jersey-grid">
                <!-- Jerseys will be loaded here -->
            </div>

            <button id="voteButton" class="vote-btn" onclick="submitVote()" disabled>
                Unesite ime i dodelite poene
            </button>

            <div id="voteMessage"></div>
        </div>

        <!-- Results View -->
        <div id="results-view" class="view">
            <h2>üèÜ Rezultati Glasanja</h2>
            <div id="resultsContent">
                <div class="loading">Uƒçitavam rezultate...</div>
            </div>
        </div>
    </div>

    <script>
        // JSONBin configuration
        const JSONBIN_API_KEY = '$2a$10$8WfZv9.7uTTJSQy3IUYRLObTfyA65QlExXIHfKgM0sDTvFqBFEQx6';
        const JSONBIN_BIN_ID = '68ab35b9d0ea881f4062e709';

        let currentData = null;
        let selectedVotes = {}; // {3: jerseyId, 2: jerseyId, 1: jerseyId}

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
        });

        function setupEventListeners() {
            const voterNameInput = document.getElementById('voterName');
            voterNameInput.addEventListener('input', validateVoterName);
        }

        async function loadData() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load data');
                }

                const result = await response.json();
                currentData = result.record;
                renderJerseys();
                renderResults();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('jerseyGrid').innerHTML = 
                    '<div class="error">Gre≈°ka pri uƒçitavanju dresova. Molimo osve≈æite stranicu.</div>';
            }
        }

        function renderJerseys() {
            const grid = document.getElementById('jerseyGrid');
            if (!currentData || !currentData.jerseys) {
                grid.innerHTML = '<div class="error">Nema dostupnih dresova.</div>';
                return;
            }

            grid.innerHTML = currentData.jerseys.map(jersey => `
                <div class="jersey-card" data-jersey-id="${jersey.id}">
                    <img src="${jersey.image}" alt="${jersey.name}" loading="lazy">
                    <h3>${jersey.name}</h3>
                    <div class="vote-options">
                        <button class="point-btn" data-points="3" data-jersey="${jersey.id}" onclick="selectPoints(${jersey.id}, 3)">3</button>
                        <button class="point-btn" data-points="2" data-jersey="${jersey.id}" onclick="selectPoints(${jersey.id}, 2)">2</button>
                        <button class="point-btn" data-points="1" data-jersey="${jersey.id}" onclick="selectPoints(${jersey.id}, 1)">1</button>
                    </div>
                </div>
            `).join('');
        }

        function selectPoints(jerseyId, points) {
            const voterName = document.getElementById('voterName').value.trim();
            if (!voterName) {
                showError('nameError', 'Prvo unesite va≈°e ime!');
                document.getElementById('voterName').focus();
                return;
            }

            // Check if this jersey already has any other point value assigned
            Object.keys(selectedVotes).forEach(existingPoints => {
                if (selectedVotes[existingPoints] === jerseyId && existingPoints != points) {
                    // Remove the previous selection from this jersey
                    const prevButton = document.querySelector(`[data-jersey="${jerseyId}"][data-points="${existingPoints}"]`);
                    if (prevButton) {
                        prevButton.classList.remove('selected');
                    }
                    delete selectedVotes[existingPoints];
                }
            });

            // Clear any existing selection for this point value from other jerseys
            if (selectedVotes[points] && selectedVotes[points] !== jerseyId) {
                const prevButton = document.querySelector(`[data-jersey="${selectedVotes[points]}"][data-points="${points}"]`);
                if (prevButton) {
                    prevButton.classList.remove('selected');
                }
            }

            // Check if this jersey already has this exact point value
            if (selectedVotes[points] === jerseyId) {
                // Deselect
                delete selectedVotes[points];
                const button = document.querySelector(`[data-jersey="${jerseyId}"][data-points="${points}"]`);
                button.classList.remove('selected');
            } else {
                // Select this jersey for this point value
                selectedVotes[points] = jerseyId;
                const button = document.querySelector(`[data-jersey="${jerseyId}"][data-points="${points}"]`);
                button.classList.add('selected');
            }

            updateJerseyCardStyles();
            updateVoteButton();
            clearMessage('voteMessage');
        }

        function updateJerseyCardStyles() {
            // Reset all cards
            document.querySelectorAll('.jersey-card').forEach(card => {
                card.classList.remove('has-vote');
            });

            // Highlight cards that have votes
            Object.values(selectedVotes).forEach(jerseyId => {
                const card = document.querySelector(`[data-jersey-id="${jerseyId}"]`);
                if (card) {
                    card.classList.add('has-vote');
                }
            });
        }

        function validateVoteSelection() {
            // Check if all three point values are selected
            return selectedVotes[3] && selectedVotes[2] && selectedVotes[1];
        }

        function updateVoteButton() {
            const button = document.getElementById('voteButton');
            const voterName = document.getElementById('voterName').value.trim();
            const isValidVote = validateVoteSelection();
            
            // Special handling for admin
            if (voterName === 'admin888') {
                button.disabled = true;
                button.textContent = 'Admin - Koristite "Rezultati" dugme';
                return;
            }
            
            if (isValidVote && voterName) {
                button.disabled = false;
                button.textContent = 'Glasaj';
            } else {
                button.disabled = true;
                if (!voterName) {
                    button.textContent = 'Unesite ime i dodelite poene';
                } else if (!isValidVote) {
                    const selectedCount = Object.keys(selectedVotes).length;
                    button.textContent = `Dodelite sve poene (${selectedCount}/3)`;
                }
            }
        }

        function validateVoterName() {
            const voterName = document.getElementById('voterName').value.trim();
            const nameError = document.getElementById('nameError');
            const resultsBtn = document.getElementById('resultsBtn');
            
            // Show/hide results button based on admin code
            if (voterName === 'admin888') {
                resultsBtn.classList.remove('hidden');
            } else {
                resultsBtn.classList.add('hidden');
            }
            
            if (!voterName) {
                clearError('nameError');
                updateVoteButton();
                return;
            }

            // Don't check for duplicate if it's admin
            if (voterName === 'admin888') {
                clearError('nameError');
                updateVoteButton();
                return true;
            }

            // Check if name already exists
            const existingVote = currentData.votes.find(vote => 
                vote.voterName.toLowerCase() === voterName.toLowerCase()
            );

            if (existingVote) {
                showError('nameError', 'Ovo ime je veƒá kori≈°ƒáeno. Molimo unesite drugaƒçije ime.');
                updateVoteButton();
                return false;
            }

            clearError('nameError');
            updateVoteButton();
            return true;
        }

        async function submitVote() {
            const voterName = document.getElementById('voterName').value.trim();
            
            // Prevent admin from voting
            if (voterName === 'admin888') {
                showMessage('voteMessage', 'Admin ne mo≈æe da glasa. Koristite "Rezultati" dugme za pregled.', 'error');
                return;
            }
            
            if (!validateVoterName() || !validateVoteSelection()) {
                if (!validateVoteSelection()) {
                    showMessage('voteMessage', 'Morate dodeliti taƒçno jednom dresu 3 boda, jednom 2 boda, i jednom 1 bod!', 'error');
                }
                return;
            }

            const button = document.getElementById('voteButton');
            button.disabled = true;
            button.textContent = '≈†alje se...';

            try {
                // Create vote object from selectedVotes
                const vote = {
                    voterName: voterName,
                    votes: Object.entries(selectedVotes).map(([points, jerseyId]) => ({
                        jerseyId: parseInt(jerseyId),
                        points: parseInt(points)
                    })),
                    timestamp: new Date().toISOString()
                };

                // Add vote to current data
                currentData.votes.push(vote);
                currentData.lastUpdated = new Date().toISOString();

                // Save to JSONBin
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(currentData)
                });

                if (!response.ok) {
                    throw new Error('Failed to save vote');
                }

                showMessage('voteMessage', `Hvala ${voterName}! Va≈° glas je uspe≈°no zabele≈æen! üéâ`, 'success');
                
                // Reset form
                resetVotingForm();
                renderResults();

            } catch (error) {
                console.error('Error submitting vote:', error);
                showMessage('voteMessage', 'Gre≈°ka pri slanju glasa. Molimo poku≈°ajte ponovo.', 'error');
                button.disabled = false;
                button.textContent = 'Glasaj';
            }
        }

        function resetVotingForm() {
            document.getElementById('voterName').value = '';
            
            // Hide results button again
            document.getElementById('resultsBtn').classList.add('hidden');
            
            // Clear selected votes
            selectedVotes = {};
            
            // Remove all button selections
            document.querySelectorAll('.point-btn').forEach(button => {
                button.classList.remove('selected');
            });
            
            // Remove visual feedback from jersey cards
            document.querySelectorAll('.jersey-card').forEach(card => {
                card.classList.remove('has-vote');
            });
            
            updateVoteButton();
            clearError('nameError');
        }

        function renderResults() {
            const container = document.getElementById('resultsContent');
            
            if (!currentData || !currentData.votes.length) {
                container.innerHTML = '<div class="loading">Jo≈° nema glasova.</div>';
                return;
            }

            // Calculate results
            const jerseyScores = {};
            const jerseyVoteDetails = {};
            
            // Initialize
            currentData.jerseys.forEach(jersey => {
                jerseyScores[jersey.id] = 0;
                jerseyVoteDetails[jersey.id] = { 3: 0, 2: 0, 1: 0 };
            });

            // Calculate scores
            currentData.votes.forEach(vote => {
                vote.votes.forEach(v => {
                    // Make sure this jersey exists in our data
                    if (jerseyScores.hasOwnProperty(v.jerseyId)) {
                        jerseyScores[v.jerseyId] += v.points;
                        jerseyVoteDetails[v.jerseyId][v.points]++;
                    } else {
                        console.warn('Vote for unknown jersey ID:', v.jerseyId);
                    }
                });
            });

            // Sort by score
            const sortedResults = currentData.jerseys
                .map(jersey => ({
                    ...jersey,
                    totalScore: jerseyScores[jersey.id] || 0,
                    details: jerseyVoteDetails[jersey.id]
                }))
                .sort((a, b) => b.totalScore - a.totalScore);

            // Generate HTML
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p><strong>Ukupno glasova:</strong> ${currentData.votes.length}</p>
                    <p><strong>Poslednje a≈æuriranje:</strong> ${new Date(currentData.lastUpdated).toLocaleString('sr-RS')}</p>
                </div>
                
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Rang</th>
                            <th>Dres</th>
                            <th>Ukupno Poena</th>
                            <th>3 boda</th>
                            <th>2 boda</th>
                            <th>1 bod</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedResults.map((jersey, index) => `
                            <tr>
                                <td><strong>${index + 1}.</strong></td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <img src="${jersey.image}" alt="${jersey.name}" 
                                             style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                                        <span><strong>${jersey.name}</strong></span>
                                    </div>
                                </td>
                                <td><strong>${jersey.totalScore}</strong></td>
                                <td>${jersey.details[3]}</td>
                                <td>${jersey.details[2]}</td>
                                <td>${jersey.details[1]}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <h3 style="margin-top: 30px;">üë• Glasaƒçi:</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    ${currentData.votes.map(vote => 
                        `<span style="display: inline-block; background: white; padding: 5px 10px; margin: 2px; border-radius: 15px; font-size: 14px;">
                            ${vote.voterName}
                        </span>`
                    ).join('')}
                </div>
            `;
        }

        function showView(viewName) {
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide views
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.add('active');

            // Refresh results if showing results view
            if (viewName === 'results') {
                renderResults();
            }
        }

        function showMessage(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function clearMessage(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
        }

        function clearError(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'none';
        }
    </script>
</body>
</html>